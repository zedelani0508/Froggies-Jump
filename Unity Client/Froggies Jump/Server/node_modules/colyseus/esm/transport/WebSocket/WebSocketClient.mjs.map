{"version":3,"file":"WebSocketClient.mjs","sources":["../../../src/transport/WebSocket/WebSocketClient.ts"],"sourcesContent":["import WebSocket from 'ws';\n\nimport { Schema } from '@colyseus/schema';\nimport { getMessageBytes, Protocol } from '../../Protocol';\nimport { Client, ClientState, ISendOptions } from '../Transport';\n\nconst SEND_OPTS = { binary: true };\n\nexport class WebSocketClient implements Client {\n  public sessionId: string;\n  public state: ClientState = ClientState.JOINING;\n  public _enqueuedMessages: any[] = [];\n\n  constructor(\n    public id: string,\n    public ref: WebSocket,\n  ) {\n    this.sessionId = id;\n  }\n\n  public send(messageOrType: any, messageOrOptions?: any | ISendOptions, options?: ISendOptions) {\n    //\n    // TODO: implement `options.afterNextPatch`\n    //\n    this.enqueueRaw(\n      (messageOrType instanceof Schema)\n        ? getMessageBytes[Protocol.ROOM_DATA_SCHEMA](messageOrType)\n        : getMessageBytes[Protocol.ROOM_DATA](messageOrType, messageOrOptions),\n      options,\n    );\n  }\n\n  public enqueueRaw(data: ArrayLike<number>, options?: ISendOptions) {\n    if (this.state === ClientState.JOINING) {\n      // sending messages during `onJoin`.\n      // - the client-side cannot register \"onMessage\" callbacks at this point.\n      // - enqueue the messages to be send after JOIN_ROOM message has been sent\n      this._enqueuedMessages.push(data);\n      return;\n    }\n\n    this.raw(data, options);\n  }\n\n  public raw(data: ArrayLike<number>, options?: ISendOptions, cb?: (err?: Error) => void) {\n    if (this.ref.readyState !== WebSocket.OPEN) {\n      console.warn('trying to send data to inactive client', this.sessionId);\n      return;\n    }\n\n    this.ref.send(data, SEND_OPTS, cb);\n  }\n\n  public error(code: number, message: string = '', cb?: (err?: Error) => void) {\n    this.raw(getMessageBytes[Protocol.ERROR](code, message), undefined, cb);\n  }\n\n  get readyState() {\n    return this.ref.readyState;\n  }\n\n  public leave(code?: number, data?: string) {\n    this.ref.close(code, data);\n  }\n\n  public close(code?: number, data?: string) {\n    console.warn('DEPRECATION WARNING: use client.leave() instead of client.close()');\n    try {\n      throw new Error();\n    } catch (e) {\n      console.log(e.stack);\n    }\n    this.leave(code, data);\n  }\n\n  public toJSON() {\n    return { sessionId: this.sessionId, readyState: this.readyState };\n  }\n}\n"],"names":[],"mappings":";;;;;AAMA,MAAM,SAAS,GAAG,EAAE,MAAM,EAAE,IAAI,EAAE,CAAC;MAEtB,eAAe;IAK1B,YACS,EAAU,EACV,GAAc;QADd,OAAE,GAAF,EAAE,CAAQ;QACV,QAAG,GAAH,GAAG,CAAW;QALhB,UAAK,GAAgB,WAAW,CAAC,OAAO,CAAC;QACzC,sBAAiB,GAAU,EAAE,CAAC;QAMnC,IAAI,CAAC,SAAS,GAAG,EAAE,CAAC;KACrB;IAEM,IAAI,CAAC,aAAkB,EAAE,gBAAqC,EAAE,OAAsB;;;;QAI3F,IAAI,CAAC,UAAU,CACb,CAAC,aAAa,YAAY,MAAM;cAC5B,eAAe,CAAC,QAAQ,CAAC,gBAAgB,CAAC,CAAC,aAAa,CAAC;cACzD,eAAe,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,aAAa,EAAE,gBAAgB,CAAC,EACxE,OAAO,CACR,CAAC;KACH;IAEM,UAAU,CAAC,IAAuB,EAAE,OAAsB;QAC/D,IAAI,IAAI,CAAC,KAAK,KAAK,WAAW,CAAC,OAAO,EAAE;;;;YAItC,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClC,OAAO;SACR;QAED,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;KACzB;IAEM,GAAG,CAAC,IAAuB,EAAE,OAAsB,EAAE,EAA0B;QACpF,IAAI,IAAI,CAAC,GAAG,CAAC,UAAU,KAAK,SAAS,CAAC,IAAI,EAAE;YAC1C,OAAO,CAAC,IAAI,CAAC,wCAAwC,EAAE,IAAI,CAAC,SAAS,CAAC,CAAC;YACvE,OAAO;SACR;QAED,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,EAAE,SAAS,EAAE,EAAE,CAAC,CAAC;KACpC;IAEM,KAAK,CAAC,IAAY,EAAE,UAAkB,EAAE,EAAE,EAA0B;QACzE,IAAI,CAAC,GAAG,CAAC,eAAe,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,IAAI,EAAE,OAAO,CAAC,EAAE,SAAS,EAAE,EAAE,CAAC,CAAC;KACzE;IAED,IAAI,UAAU;QACZ,OAAO,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC;KAC5B;IAEM,KAAK,CAAC,IAAa,EAAE,IAAa;QACvC,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;KAC5B;IAEM,KAAK,CAAC,IAAa,EAAE,IAAa;QACvC,OAAO,CAAC,IAAI,CAAC,mEAAmE,CAAC,CAAC;QAClF,IAAI;YACF,MAAM,IAAI,KAAK,EAAE,CAAC;SACnB;QAAC,OAAO,CAAC,EAAE;YACV,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;SACtB;QACD,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;KACxB;IAEM,MAAM;QACX,OAAO,EAAE,SAAS,EAAE,IAAI,CAAC,SAAS,EAAE,UAAU,EAAE,IAAI,CAAC,UAAU,EAAE,CAAC;KACnE;;;;;"}